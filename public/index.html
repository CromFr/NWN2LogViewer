<!doctype html>
<html lang="en" ng-app="mainApp">
<head>
	<meta charset="utf-8">
	<title>NWN Log viewer</title>
	<link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css"/>
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
	<script src="//cdn.jsdelivr.net/jquery/1/jquery.min.js"></script>
	<script src="lib/bootstrap/dist/js/bootstrap.min.js"></script>

	<script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>

	<script type="text/javascript">
		function getParameterByName(name) {
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
			return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		var app = angular.module('mainApp', []);


		app.controller('NavbarCtrl', function($scope, $http){
			$http.get('providers').success(function(data) {
				$scope.navbarMenus = data;
			});
		});

		app.controller('LogCtrl', function($scope, $http){
			if(getParameterByName("logs")){
				$http.get(getParameterByName("logs").replace('.','/')+'/data').success(function(data){
					$scope.columns = data.columns;
					$scope.orderColumn = $scope.columns[0].code;

					$scope.logs = data.data;

					$scope.update = function(){
					};

					setTimeout(function(){
						 $('input[name="daterange"]').daterangepicker({
							"showDropdowns": true,
							"showWeekNumbers": true,
							"timePicker": true,
							"timePicker24Hour": true,
							"timePickerSeconds": true,
							"startDate": "09/03/2015",
							"endDate": "09/09/2015",
						}, function(start, end, label) {
							console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label + ')');
						});
					}, 0);
				});
			}

		});

		app.filter('logFilter', function() {
			var $scope = angular.element($('[ng-controller="LogCtrl"]')).scope();
			return function(lines) {
				if(lines){

					return lines.filter(function(line, index, array){

						for (var key in $scope.columns){
							var colType = $scope.columns[key].type;
							var colCode = $scope.columns[key].code;
							var cellValue = line[key];

							if(colType=="int" || colType=="float" || colType=="date"){
								var from = $('#search_from_'+colCode).val();
								var to = $('#search_to_'+colCode).val();

								if(from && cellValue<from)return false;
								if(to && cellValue>to)return false;
							}
							else if(colType=="bool"){
								var radioValue = $('input[name="search_'+colCode+'"]:checked').val();

								if(radioValue!="" && cellValue!=radioValue)
								 	return false;
							}
							else if(colType=="text"){
								var searchFor = $('#search_'+colCode).val();
								if(searchFor){
									if(cellValue.toLowerCase().search(searchFor.toLowerCase())==-1)
										return false;
								}
							}
						}
						return true;
					});
				}
				return lines;
			};
		});

		

	</script>
</head>
<!-- ######################################## -->
<body>

	<nav ng-controller="NavbarCtrl" class="navbar navbar-inverse navbar-static-top">
		<div class="container-fluid">

			<div class="navbar-header">
				<a class="navbar-brand" href="https://github.com/CromFr/NWNLogViewer">NWNLogViewer</a>
			</div>

			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li class="dropdown" ng-repeat="(header, menus) in navbarMenus" ng-class="active">
						<a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
							{{header}}<span class="caret"></span>
						</a>
						<ul class="dropdown-menu">
							<li ng-repeat="menu in menus">
								<a href="?logs={{header}}.{{menu}}">{{menu}}</a>
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<div ng-controller="LogCtrl">
		<div class="container">
			<table class="table table-bordered">
				<tr class="form-inline form-group" ng-repeat="column in columns">
					<td><label class="control-label">{{column.name}}</label></td>

					<td ng-if="column.type=='text'">
						<input id="search_{{column.code}}" type="text" class="form-control" placeholder="Containing..." ng-blur="update()"/>
					</td>
					<td ng-if="column.type=='int' || column.type=='float'">
						<input id="search_from_{{column.code}}" type="number" class="form-control" placeholder="From" ng-blur="update()"/>
						<input id="search_to_{{column.code}}" type="number" class="form-control" placeholder="To" ng-blur="update()"/>
					</td>
					<td ng-if="column.type=='bool'">
						<div class="btn-group" data-toggle="buttons">
							<label class="btn btn-default active">
								<input name="search_{{column.code}}" type="radio" autocomplete="off" value="" ng-click="update()" checked>Any
							</label>
							<label class="btn btn-success">
								<input name="search_{{column.code}}" type="radio" autocomplete="off" value="1" ng-click="update()">Yes
							</label>
							<label class="btn btn-danger">
								<input name="search_{{column.code}}" type="radio" autocomplete="off" value="0" ng-click="update()">No
							</label>
						</div>
					</td>
					<td ng-if="column.type=='date'">
						<div class="input-group">
							<input id="datePicker_{{column.code}}" name="daterange" class="form-control"
								type="text" value="01/01/2015 1:30 PM - 01/01/2015 2:00 PM" />
							<span class="input-group-addon">
								<span class="glyphicon glyphicon-calendar"></span>
							</span>
						</div>
					</td>
				</tr>
			</table>
		</div>

		<table class="table table-striped table-condensed">
			<thead><tr>
				<th ng-repeat="column in columns" 
					ng-click="$parent.orderColumn=($parent.orderColumn==column.code)? '-'+column.code : column.code"
					class="btn-default" style="cursor:pointer">

					{{column.name}}
					<span
						class="glyphicon {{($parent.orderColumn==column.code)? 'glyphicon-sort-by-attributes' : 'glyphicon-sort-by-attributes-alt'}}"
						style="opacity:{{$parent.orderColumn==column.code||$parent.orderColumn==('-'+column.code)? '1.0' : '0.0'}}"
						aria-hidden="true">
					</span>
				</th>
			</tr></thead>

			<tr ng-repeat="entry in logs | logFilter | orderBy:orderColumn">
				<td ng-repeat="(index,column) in columns">
					<div ng-if="column.type=='float'">
						{{entry[index] | number:2}}
					</div>
					<div ng-if="column.type=='bool'">
						<span class="glyphicon {{entry[index]? 'glyphicon-ok' : 'glyphicon-remove'}}"></span>
					</div>
					<div ng-if="column.type!='float' && column.type!='bool'">
						{{entry[index]}}
					</div>
				</td>
			</tr>

		</table>
	</div>


</body>
</html>
