<!doctype html>
<html lang="en" ng-app="mainApp">
<head>
	<meta charset="utf-8">
	<title>Log viewer</title>
	<link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css"/>
	<link rel="stylesheet" href="lib/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"/>

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="lib/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="lib/moment/min/moment.min.js"></script>
	<script type="text/javascript" src="lib/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>

	<script type="text/javascript">
		function getParameterByName(name) {
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
			return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		var app = angular.module('mainApp', []);


		app.controller('NavbarCtrl', function($scope, $http){
			$http.get('providers').success(function(data) {
				$scope.navbarMenus = data;
			});
		});

		app.controller('LogCtrl', function($scope, $http){
			if(getParameterByName("logs")){
				$http.get(getParameterByName("logs").replace('.','/')+'/data').success(function(data) {
					$scope.columns = data.columns;
					$scope.orderColumn = $scope.columns[0].code;

					$scope.logs = data.data;
				});
			}

		});

		app.filter('logFilter', function() {
			return function(lines) {
				// if(lines){
				// 	return lines.filter(function(line, index, array) {
				// 		var display = true;

				// 		var keys = Object.keys(line);
				// 		var length = keys.length;
				// 		console.log(length);
				// 		for (var i=0 ; i<length ; i++){
				// 			console.log(line);
				// 			console.log(i);
				// 			var type = "text";//columns[i].code.type;
				// 			var colCode = line[keys[i]].code;
				// 			var colValue = line[keys[i]].value;
				// 			if(type=="int" || type=="float" || type=="date"){
				// 				var from = $('search_from_'+colCode).val();
				// 				var to = $('search_to_'+colCode).val();
				// 				display &= (from? from<=colValue : true) && (to? colValue<=to : true);
				// 			}
				// 			else if(type=="text"){
				// 				display &= colValue.toLowerCase().search($('search_'+colCode).val().toLowerCase());
				// 			}

				// 			if(!display)
				// 				return false;
				// 		};
				// 		return true;
				// 	});
				// }
				return lines;
			};
		});

		

	</script>
</head>
<!-- ######################################## -->
<body>

	<nav ng-controller="NavbarCtrl" class="navbar navbar-inverse navbar-static-top">
		<div class="container-fluid">

			<div class="navbar-header">
				<a class="navbar-brand" href="https://github.com/CromFr/NWNLogViewer">NWNLogViewer</a>
			</div>

			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li class="dropdown" ng-repeat="(header, menus) in navbarMenus" ng-class="active">
						<a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
							{{header}}<span class="caret"></span>
						</a>
						<ul class="dropdown-menu">
							<li ng-repeat="menu in menus">
								<a href="?logs={{header}}.{{menu}}">{{menu}}</a>
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<div ng-controller="LogCtrl">
		<div class="container">
			<table class="table table-bordered">
				<tr class="form-inline form-group" ng-repeat="column in columns">
					<td><label class="control-label">{{column.name}}</label></td>

					<td ng-if="column.type=='text'">
						<input id="search_{{column.code}}" type="text" class="form-control" placeholder="Containing...">
					</td>
					<td ng-if="column.type=='int' || column.type=='float'">
						<input id="search_from_{{column.code}}" type="number" class="form-control" placeholder="From">
						<input id="search_to_{{column.code}}" type="number" class="form-control" placeholder="To">
					</td>
					<td ng-if="column.type=='date'">
						<div id="datePickerFrom_{{column.code}}" class="input-group date">
							<input id="search_from_{{column.code}}" type="text" class="form-control" placeholder="From"/>
							<span class="input-group-addon">
								<span class="glyphicon glyphicon-calendar"></span>
							</span>
						</div>
						<label for="datePickerTo">To</label>
						<div id="datePickerTo_{{column.code}}" class="input-group date">
							<input id="search_to_{{column.code}}" type="text" class="form-control" placeholder="To"/>
							<span class="input-group-addon">
								<span class="glyphicon glyphicon-calendar"></span>
							</span>
						</div>
						<script type="text/javascript">
							// var scope = angular.element($('div[ng-controller="LogCtrl"]')).scope();
							// $('#datePickerFrom_'+scope.column.code).datetimepicker({
							// 	format: 'YYYY-MM-DD HH:MM:SS'
							// });
							// $('#datePickerTo_'+scope.column.code).datetimepicker({
							// 	format: 'YYYY-MM-DD HH:MM:SS'
							// });
						</script>
					</td>
				</tr>
			</table>
		</div>

		<table class="table table-striped table-condensed">
			<thead><tr>
				<th ng-repeat="column in columns" 
					ng-click="$parent.orderColumn=($parent.orderColumn==column.code)? '-'+column.code : column.code"
					class="btn-default" style="cursor:pointer">

					{{column.name}}
					<span
						class="glyphicon {{($parent.orderColumn==column.code)? 'glyphicon-sort-by-attributes' : 'glyphicon-sort-by-attributes-alt'}}"
						style="opacity:{{$parent.orderColumn==column.code||$parent.orderColumn==('-'+column.code)? '1.0' : '0.0'}}"
						aria-hidden="true">
					</span>
				</th>
			</tr></thead>

			<tr ng-repeat="entry in logs | logFilter | orderBy:orderColumn">
				<td ng-repeat="(index,column) in columns">
					<div ng-if="column.type=='float'">
						{{entry[index] | number:2}}
					</div>
					<div ng-if="column.type!='float'">
						{{entry[index]}}
					</div>
				</td>
			</tr>

		</table>
	</div>


</body>
</html>
